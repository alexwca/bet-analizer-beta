<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>ANÁLISE DE RANKING</title>
    <style>
        * {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid rgb(158, 158, 158);
            padding: 8px;
            text-align: left;
            color: rgb(52, 52, 52);
        }

        textarea {
            resize: none;
            min-width: 400px;
            height: 200px;
        }

        #filterExpose {
            text-transform: uppercase;
        }

        #filter {
            padding: 5px 10px;
        }

        button {
            margin: 10px 0;
            padding: 5px 10px;
        }

        table {
            display: none;
        }

        table tr:nth-child(even) {
            background-color: #dbdbdb;
        }

        .matchTable {
            display: block;
            font-size: 10px;
        }

        .highlight {
            border: 2px solid red;
            color: red;
        }
    </style>
</head>

<body>
    <h1>ANÁLISE DE RANKING</h1>
    <label for="filter">Escolha o filtro de análise:</label>
    <select id="filter">
        <option value="highScoring" data-weight="2">OVER 3.5</option>
        <option value="veryHighScoring" data-weight="3">5+</option>
        <option value="homeWins" data-weight="1">Casa vence</option>
        <option value="awayWins" data-weight="1">Visitante vence</option>
        <option value="draw" data-weight="1">Empate</option>
    </select>
    <br><br>
    <textarea id="negativeInput" rows="10" cols="50"
        placeholder="Insira os dados da linha operacional a validar as negativas..."></textarea>
    <br>
    <br>
    <textarea id="dataInput" rows="10" cols="50" placeholder="Insira os dados dos jogos para criação do rank..."></textarea>
    <br>
    
    <button onclick="processData()">ANALISAR</button>
    <button onclick="clearData()">LIMPAR</button>

    <table id="matchTable" class="matchTable">
        <tbody></tbody>
    </table>
    <br>
    <br>

    <table id="missingTeamsTable" class="matchTable">
        <thead>
            <tr>
                <th>Times rankeados não encontrados na linha operacional.</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <br>
    <br>

    <table id="resultsTable">
        <thead>
            <tr>
                <th>TIME</th>
                <th>PONTOS</th>
                <th>PARTIDAS JOGADAS</th>
                <th>JOGOS <span id="filterExpose"></span></th>
                <th>% &nbsp;
                    <button id="btn-up" onclick="sortByPercentage()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-chevron-up" viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                d="M8 6.293l-4.646 4.647-.708-.708L8 4.879l5.354 5.353-.708.708L8 6.293z" />
                        </svg>
                    </button>

                    <button id="btn-down" onclick="processData()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-chevron-down" viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
                        </svg>
                    </button>
                </th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        var state = false;

        function processData() {
            let data = document.getElementById('dataInput').value;
            let negativeData = document.getElementById('negativeInput').value;
            let filter = document.getElementById('filter').value;
            document.getElementById('btn-down').style.display = 'none';
            document.getElementById('btn-up').style.display = 'block';

            switch (filter) {
                case 'highScoring':
                    document.getElementById('filterExpose').innerText = 'OVER 3.5';
                    break;

                case 'veryHighScoring':
                    document.getElementById('filterExpose').innerText = '5+';
                    break;

                case 'homeWins':
                    document.getElementById('filterExpose').innerText = 'Casa Vence';
                    break;

                case 'awayWins':
                    document.getElementById('filterExpose').innerText = 'Visitante Vence';
                    break;

                case 'draw':
                    document.getElementById('filterExpose').innerText = 'Empate';
                    break;
            }

            data = data.replace(/['"]+/g, '');
            negativeData = negativeData.replace(/['"]+/g, '');

            const games = data.trim().split(/\t|\n/);
            const negativeGames = negativeData.trim().split(/\t|\n/);

            const matches = [];
            for (let i = 0; i < games.length; i += 2) {
                const teams = games[i].trim();
                const score = games[i + 1].trim();
                matches.push({ teams, score });
            }

            const negativeMatches = [];
            for (let i = 0; i < negativeGames.length; i += 2) {
                const teams = negativeGames[i].trim();
                const score = negativeGames[i + 1].trim();
                negativeMatches.push({ teams, score });
            }

            const teamStats = {};
            matches.forEach(match => {
                const [team1, team2] = match.teams.split(' x ');
                const [score1, score2] = match.score.split('-').map(Number);
                const totalGoals = score1 + score2;

                if (!teamStats[team1]) {
                    teamStats[team1] = { highScoringGames: 0, veryHighScoringGames: 0, homeWins: 0, awayWins: 0, draws: 0, totalGames: 0, points: 0 };
                }
                if (!teamStats[team2]) {
                    teamStats[team2] = { highScoringGames: 0, veryHighScoringGames: 0, homeWins: 0, awayWins: 0, draws: 0, totalGames: 0, points: 0 };
                }

                teamStats[team1].totalGames++;
                teamStats[team2].totalGames++;

                if (totalGoals >= 3.5) {
                    teamStats[team1].highScoringGames++;
                    teamStats[team2].highScoringGames++;
                }
                if (totalGoals >= 5) {
                    teamStats[team1].veryHighScoringGames++;
                    teamStats[team2].veryHighScoringGames++;
                }
                if (score1 > score2) {
                    teamStats[team1].homeWins++;
                    teamStats[team1].points += 3;
                } else if (score2 > score1) {
                    teamStats[team2].awayWins++;
                    teamStats[team2].points += 3;
                } else {
                    teamStats[team1].draws++;
                    teamStats[team2].draws++;
                    teamStats[team1].points += 1;
                    teamStats[team2].points += 1;
                }
            });

            const filterOption = document.getElementById('filter').value;
            const filterWeight = parseInt(document.getElementById('filter').selectedOptions[0].getAttribute('data-weight'));
            const tbody = document.getElementById('resultsTable').querySelector('tbody');
            tbody.innerHTML = '';

            const results = [];
            Object.keys(teamStats).forEach(team => {
                const games = getGamesByFilter(teamStats[team], filterOption);
                const totalGames = teamStats[team].totalGames;
                const points = teamStats[team].points;
                const participationPoints = games * filterWeight;

                results.push({ team, games, totalGames, points, participationPoints });
            });

            results.sort((a, b) => {
                const percentageA = a.games / a.totalGames;
                const percentageB = b.games / b.totalGames;

                if (percentageB !== percentageA) {
                    return percentageB - percentageA;
                }

                return (b.points * b.participationPoints) - (a.points * a.participationPoints);
            });

            results.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                  <td>${result.team}</td>
                  <td>${result.points}</td>
                  <td>${result.totalGames}</td>
                  <td>${result.games}</td>
                  <td>${(result.games / result.totalGames * 100).toFixed(2)}</td>
                `;
                tbody.appendChild(row);
                document.getElementById('resultsTable').style.display = 'block';
            });

            createMatchTable(negativeMatches, 'matchTable', results.slice(0, 5).map(result => result.team));
            validateTopTeams(results, negativeMatches);
        }

        function getGamesByFilter(stats, filterOption) {
            switch (filterOption) {
                case 'highScoring':
                    return stats.highScoringGames;
                case 'veryHighScoring':
                    return stats.veryHighScoringGames;
                case 'homeWins':
                    return stats.homeWins;
                case 'awayWins':
                    return stats.awayWins;
                case 'draw':
                    return stats.draws;
                default:
                    return 0;
            }
        }

        function clearData() {
            document.getElementById('dataInput').value = "";
            document.getElementById('negativeInput').value = "";
            document.getElementById('resultsTable').style.display = 'none';
            document.getElementById('matchTable').style.display = 'none';
            document.getElementById('missingTeamsTable').style.display = 'none';
        }

        function createMatchTable(matches, tableId, topTeams) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';

            const row = document.createElement('tr');
            matches.forEach(match => {
                const cell = document.createElement('td');
                cell.textContent = `${match.teams}\n${match.score}`;
                const [team1, team2] = match.teams.split(' x ');
                const [score1, score2] = match.score.split('-').map(Number);
                const totalGoals = score1 + score2;

                if ((topTeams.includes(team1) || topTeams.includes(team2)) && totalGoals < 3) {
                    cell.classList.add('highlight');
                }

                row.appendChild(cell);
            });
            tbody.appendChild(row);
            table.style.display = 'block';
        }

        function validateTopTeams(results, negativeMatches) {
            const topTeams = results.slice(0, 5).map(result => result.team);
            const matchTeams = new Set(negativeMatches.flatMap(match => match.teams.split(' x ')));

            const missingTeams = topTeams.filter(team => !matchTeams.has(team));

            const missingTbody = document.getElementById('missingTeamsTable').querySelector('tbody');
            missingTbody.innerHTML = '';

            missingTeams.forEach(team => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${team}</td>`;
                missingTbody.appendChild(row);
            });

            if (missingTeams.length > 0) {
                document.getElementById('missingTeamsTable').style.display = 'block';
            } else {
                document.getElementById('missingTeamsTable').style.display = 'none';
            }
        }
    </script>
</body>

</html>